<?xml version="1.0" encoding="UTF-8"?>
<devops-config version="1.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xsi:noNamespaceSchemaLocation="../schemas/config.xsd">
    <application>
        <name>my-web-app</name>
        <version>1.0.0</version>
        <description>Application web avec base de données</description>
    </application>
    
    <environments>
        <!-- Environnement de développement -->
        <environment>
            <name>dev</name>
            <services>
                <service>
                    <name>web</name>
                    <image>nginx</image>
                    <tag>alpine</tag>
                    <ports>
                        <port>
                            <host>8080</host>
                            <container>80</container>
                            <protocol>tcp</protocol>
                        </port>
                    </ports>
                    <volumes>
                        <volume>
                            <host_path>./html</host_path>
                            <container_path>/usr/share/nginx/html</container_path>
                            <mode>ro</mode>
                        </volume>
                    </volumes>
                    <environment>
                        <variable>
                            <name>NGINX_HOST</name>
                            <value>localhost</value>
                        </variable>
                        <variable>
                            <name>NGINX_PORT</name>
                            <value>80</value>
                        </variable>
                    </environment>
                    <depends_on>
                        <service>api</service>
                    </depends_on>
                </service>
                
                <service>
                    <name>api</name>
                    <image>python</image>
                    <tag>3.11-slim</tag>
                    <ports>
                        <port>
                            <host>5000</host>
                            <container>5000</container>
                        </port>
                    </ports>
                    <environment>
                        <variable>
                            <name>FLASK_ENV</name>
                            <value>development</value>
                        </variable>
                        <variable>
                            <name>DATABASE_URL</name>
                            <value>postgresql://user:pass@db:5432/mydb</value>
                        </variable>
                    </environment>
                    <depends_on>
                        <service>db</service>
                    </depends_on>
                    <command>python app.py</command>
                    <working_dir>/app</working_dir>
                </service>
                
                <service>
                    <name>db</name>
                    <image>postgres</image>
                    <tag>15-alpine</tag>
                    <ports>
                        <port>
                            <host>5432</host>
                            <container>5432</container>
                        </port>
                    </ports>
                    <volumes>
                        <volume>
                            <host_path>./data</host_path>
                            <container_path>/var/lib/postgresql/data</container_path>
                        </volume>
                    </volumes>
                    <environment>
                        <variable>
                            <name>POSTGRES_DB</name>
                            <value>mydb</value>
                        </variable>
                        <variable>
                            <name>POSTGRES_USER</name>
                            <value>user</value>
                        </variable>
                        <variable>
                            <name>POSTGRES_PASSWORD</name>
                            <value>password</value>
                        </variable>
                    </environment>
                </service>
            </services>
            <variables>
                <variable>
                    <name>LOG_LEVEL</name>
                    <value>DEBUG</value>
                </variable>
            </variables>
        </environment>
        
        <!-- Environnement de production -->
        <environment>
            <name>prod</name>
            <services>
                <service>
                    <name>web</name>
                    <image>nginx</image>
                    <tag>alpine</tag>
                    <ports>
                        <port>
                            <host>80</host>
                            <container>80</container>
                        </port>
                        <port>
                            <host>443</host>
                            <container>443</container>
                        </port>
                    </ports>
                    <replicas>3</replicas>
                </service>
                
                <service>
                    <name>api</name>
                    <image>my-registry/api</image>
                    <tag>1.0.0</tag>
                    <ports>
                        <port>
                            <host>5000</host>
                            <container>5000</container>
                        </port>
                    </ports>
                    <replicas>5</replicas>
                </service>
                
                <service>
                    <name>db</name>
                    <image>postgres</image>
                    <tag>15-alpine</tag>
                    <replicas>1</replicas>
                </service>
            </services>
            <variables>
                <variable>
                    <name>LOG_LEVEL</name>
                    <value>INFO</value>
                </variable>
                <variable>
                    <name>ENVIRONMENT</name>
                    <value>production</value>
                </variable>
            </variables>
            <secrets>
                <secret>
                    <name>DATABASE_PASSWORD</name>
                    <source>AWS_SECRETS_MANAGER</source>
                    <key>prod/db/password</key>
                </secret>
                <secret>
                    <name>API_KEY</name>
                    <source>VAULT</source>
                    <key>secret/api/key</key>
                </secret>
            </secrets>
            <kubernetes>
                <namespace>production</namespace>
                <resources>
                    <requests>
                        <cpu>500m</cpu>
                        <memory>512Mi</memory>
                    </requests>
                    <limits>
                        <cpu>2000m</cpu>
                        <memory>2Gi</memory>
                    </limits>
                </resources>
                <service>
                    <type>LoadBalancer</type>
                    <ports>
                        <port>
                            <port>80</port>
                            <target_port>80</target_port>
                            <protocol>TCP</protocol>
                        </port>
                    </ports>
                </service>
            </kubernetes>
        </environment>
    </environments>
</devops-config>
