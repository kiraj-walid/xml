<?xml version="1.0" encoding="UTF-8"?>
<!-- 
    Exemple de configuration DevOps annotée
    Ce fichier illustre toutes les fonctionnalités disponibles dans le format XML
-->
<devops-config version="1.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xsi:noNamespaceSchemaLocation="../schemas/config.xsd">
    
    <!-- 
        Section Application
        Définit les métadonnées générales de l'application
    -->
    <application>
        <!-- Nom de l'application (obligatoire) -->
        <name>my-web-app</name>
        
        <!-- Version de l'application (obligatoire) -->
        <version>1.0.0</version>
        
        <!-- Description optionnelle de l'application -->
        <description>Application web avec API REST et base de données PostgreSQL</description>
    </application>
    
    <!-- 
        Section Environnements
        Définit les différents environnements de déploiement
    -->
    <environments>
        
        <!-- 
            Environnement de Développement
            Configuration pour l'environnement de développement local
        -->
        <environment>
            <name>dev</name>
            
            <!-- 
                Services/Conteneurs
                Définit tous les conteneurs Docker nécessaires
            -->
            <services>
                
                <!-- Service Web (Nginx) -->
                <service>
                    <!-- Nom unique du service -->
                    <name>web</name>
                    
                    <!-- Image Docker à utiliser -->
                    <image>nginx</image>
                    
                    <!-- Tag de l'image (optionnel, défaut: latest) -->
                    <tag>alpine</tag>
                    
                    <!-- 
                        Ports exposés
                        Mappe les ports de l'hôte vers les ports du conteneur
                    -->
                    <ports>
                        <port>
                            <!-- Port sur la machine hôte -->
                            <host>8080</host>
                            <!-- Port dans le conteneur -->
                            <container>80</container>
                            <!-- Protocole (optionnel, défaut: tcp) -->
                            <protocol>tcp</protocol>
                        </port>
                    </ports>
                    
                    <!-- 
                        Volumes montés
                        Partage de fichiers/dossiers entre hôte et conteneur
                    -->
                    <volumes>
                        <volume>
                            <!-- Chemin sur la machine hôte -->
                            <host_path>./html</host_path>
                            <!-- Chemin dans le conteneur -->
                            <container_path>/usr/share/nginx/html</container_path>
                            <!-- Mode: rw (lecture/écriture) ou ro (lecture seule) -->
                            <mode>ro</mode>
                        </volume>
                    </volumes>
                    
                    <!-- 
                        Variables d'environnement spécifiques au service
                        Surcharge les variables globales de l'environnement
                    -->
                    <environment>
                        <variable>
                            <name>NGINX_HOST</name>
                            <value>localhost</value>
                        </variable>
                        <variable>
                            <name>NGINX_PORT</name>
                            <value>80</value>
                        </variable>
                    </environment>
                    
                    <!-- 
                        Dépendances
                        Liste les services qui doivent démarrer avant ce service
                    -->
                    <depends_on>
                        <service>api</service>
                    </depends_on>
                </service>
                
                <!-- Service API (Python Flask) -->
                <service>
                    <name>api</name>
                    <image>python</image>
                    <tag>3.11-slim</tag>
                    
                    <ports>
                        <port>
                            <host>5000</host>
                            <container>5000</container>
                        </port>
                    </ports>
                    
                    <environment>
                        <!-- Variables d'environnement pour l'API -->
                        <variable>
                            <name>FLASK_ENV</name>
                            <value>development</value>
                        </variable>
                        <variable>
                            <!-- Utilise le nom du service 'db' comme hostname -->
                            <name>DATABASE_URL</name>
                            <value>postgresql://user:pass@db:5432/mydb</value>
                        </variable>
                    </environment>
                    
                    <!-- Commande à exécuter au démarrage du conteneur -->
                    <command>python app.py</command>
                    
                    <!-- Répertoire de travail dans le conteneur -->
                    <working_dir>/app</working_dir>
                    
                    <depends_on>
                        <service>db</service>
                    </depends_on>
                </service>
                
                <!-- Service Base de Données (PostgreSQL) -->
                <service>
                    <name>db</name>
                    <image>postgres</image>
                    <tag>15-alpine</tag>
                    
                    <ports>
                        <port>
                            <host>5432</host>
                            <container>5432</container>
                        </port>
                    </ports>
                    
                    <volumes>
                        <!-- Volume persistant pour les données PostgreSQL -->
                        <volume>
                            <host_path>./data</host_path>
                            <container_path>/var/lib/postgresql/data</container_path>
                            <!-- Mode rw par défaut pour la base de données -->
                        </volume>
                    </volumes>
                    
                    <environment>
                        <variable>
                            <name>POSTGRES_DB</name>
                            <value>mydb</value>
                        </variable>
                        <variable>
                            <name>POSTGRES_USER</name>
                            <value>user</value>
                        </variable>
                        <variable>
                            <name>POSTGRES_PASSWORD</name>
                            <value>password</value>
                        </variable>
                    </environment>
                </service>
            </services>
            
            <!-- 
                Variables Globales
                Variables partagées par tous les services de cet environnement
            -->
            <variables>
                <variable>
                    <name>LOG_LEVEL</name>
                    <value>DEBUG</value>
                </variable>
                <variable>
                    <name>ENVIRONMENT</name>
                    <value>development</value>
                </variable>
            </variables>
        </environment>
        
        <!-- 
            Environnement de Production
            Configuration optimisée pour la production
        -->
        <environment>
            <name>prod</name>
            
            <services>
                <service>
                    <name>web</name>
                    <image>nginx</image>
                    <tag>alpine</tag>
                    
                    <ports>
                        <port>
                            <host>80</host>
                            <container>80</container>
                        </port>
                        <port>
                            <host>443</host>
                            <container>443</container>
                        </port>
                    </ports>
                    
                    <!-- Nombre de répliques pour Kubernetes -->
                    <replicas>3</replicas>
                </service>
                
                <service>
                    <name>api</name>
                    <!-- Image depuis un registre privé en production -->
                    <image>my-registry/api</image>
                    <tag>1.0.0</tag>
                    
                    <ports>
                        <port>
                            <host>5000</host>
                            <container>5000</container>
                        </port>
                    </ports>
                    
                    <replicas>5</replicas>
                </service>
                
                <service>
                    <name>db</name>
                    <image>postgres</image>
                    <tag>15-alpine</tag>
                    <replicas>1</replicas>
                </service>
            </services>
            
            <variables>
                <variable>
                    <name>LOG_LEVEL</name>
                    <value>INFO</value>
                </variable>
                <variable>
                    <name>ENVIRONMENT</name>
                    <value>production</value>
                </variable>
            </variables>
            
            <!-- 
                Secrets
                Références vers des secrets stockés dans des gestionnaires externes
                Les valeurs réelles ne sont JAMAIS stockées dans le XML
            -->
            <secrets>
                <secret>
                    <!-- Nom du secret -->
                    <name>DATABASE_PASSWORD</name>
                    <!-- Source: AWS_SECRETS_MANAGER, VAULT, etc. -->
                    <source>AWS_SECRETS_MANAGER</source>
                    <!-- Clé dans le gestionnaire de secrets -->
                    <key>prod/db/password</key>
                </secret>
                <secret>
                    <name>API_KEY</name>
                    <source>VAULT</source>
                    <key>secret/api/key</key>
                </secret>
            </secrets>
            
            <!-- 
                Configuration Kubernetes Spécifique
                Paramètres uniquement pour les déploiements Kubernetes
            -->
            <kubernetes>
                <!-- Namespace Kubernetes -->
                <namespace>production</namespace>
                
                <!-- 
                    Ressources
                    Limites CPU et mémoire pour les conteneurs
                -->
                <resources>
                    <!-- Ressources demandées (requests) -->
                    <requests>
                        <!-- CPU: 500m = 0.5 CPU core -->
                        <cpu>500m</cpu>
                        <!-- Mémoire: 512Mi = 512 Mebibytes -->
                        <memory>512Mi</memory>
                    </requests>
                    
                    <!-- Ressources maximales (limits) -->
                    <limits>
                        <!-- CPU: 2000m = 2 CPU cores -->
                        <cpu>2000m</cpu>
                        <!-- Mémoire: 2Gi = 2 Gibibytes -->
                        <memory>2Gi</memory>
                    </limits>
                </resources>
                
                <!-- 
                    Service Kubernetes
                    Configuration du service pour exposer l'application
                -->
                <service>
                    <!-- Type: ClusterIP, NodePort, LoadBalancer -->
                    <type>LoadBalancer</type>
                    
                    <ports>
                        <port>
                            <!-- Port du service -->
                            <port>80</port>
                            <!-- Port cible dans le pod -->
                            <target_port>80</target_port>
                            <!-- Protocole: TCP ou UDP -->
                            <protocol>TCP</protocol>
                        </port>
                    </ports>
                </service>
            </kubernetes>
        </environment>
    </environments>
</devops-config>

<!-- 
    Notes importantes:
    
    1. Ordre des éléments: Respectez l'ordre défini dans le schéma XSD
       - volumes doit venir avant environment dans un service
       
    2. Secrets: Ne JAMAIS mettre de valeurs de secrets en clair dans le XML
       Utilisez toujours des références vers des gestionnaires de secrets
       
    3. Environnements: Chaque environnement peut avoir des configurations différentes
       pour les mêmes services (images, ports, variables, etc.)
       
    4. Validation: Toujours valider votre XML contre le schéma XSD avant utilisation
       
    5. Transformation: Les fichiers générés peuvent être utilisés directement
       avec Docker Compose ou kubectl
-->
